<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Website Builder Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; color: #333; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    #credits { font-weight: bold; }
    #prompt { width: 100%; height: 80px; margin-bottom: 10px; }
    button { padding: 8px 12px; margin-right: 5px; cursor: pointer; }
    #console { background: #222; color: #0f0; padding: 10px; height: 120px; overflow-y: auto; font-family: monospace; margin-bottom: 10px; }
    #preview { white-space: pre-wrap; background: #fff; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: auto; margin-bottom: 10px; }
    #render { width: 100%; height: 400px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <div id="credits">Credits: 0</div>
    <button id="logout">Logout</button>
  </header>

  <textarea id="prompt" placeholder="Enter your prompt here..."></textarea><br>
  <button id="generate">Generate</button>
  <button id="copyBtn">Copy HTML</button>

  <h3>AI Console</h3>
  <div id="console"></div>

  <h3>Preview HTML</h3>
  <div id="preview"></div>

  <h3>Live Render</h3>
  <iframe id="render"></iframe>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // Supabase frontend anon
    const SUPABASE_URL = "https://qtavfdeifmkkyptgfwdl.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_FULL_ANON_KEY_HERE";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // Load user
    const stored = JSON.parse(localStorage.getItem('ssaib_user')||'{}')
    if(!stored.id) window.location.href='/index.html'

    const creditsEl = document.getElementById('credits')
    const consoleEl = document.getElementById('console')
    const previewEl = document.getElementById('preview')
    const promptEl = document.getElementById('prompt')
    const renderEl = document.getElementById('render')
    const copyBtn = document.getElementById('copyBtn')

    // Logout
    document.getElementById('logout').addEventListener('click', async ()=>{
      await supabase.auth.signOut()
      localStorage.removeItem('ssaib_user')
      window.location.href='/index.html'
    })

    // Load credits
    async function loadCredits(){
      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({user_id: stored.id, action: 'getCredits'})
        })
        const data = await res.json()
        creditsEl.textContent = 'Credits: ' + (data.credits ?? 0)
      } catch(err){
        consoleEl.textContent = 'Failed to load credits: ' + err.message
      }
    }
    loadCredits()

    // Generate
    document.getElementById('generate').addEventListener('click', async ()=>{
      const prompt = promptEl.value.trim()
      if(!prompt) return alert('Please enter a prompt!')

      consoleEl.textContent = 'AI is thinking...'
      previewEl.textContent = ''
      renderEl.srcdoc = ''

      try{
        const res = await fetch('/api/generate',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({prompt,user_id:stored.id})
        })
        const data = await res.json()
        if(data.error){
          consoleEl.textContent = 'Error: ' + data.error
          return
        }
        consoleEl.textContent = 'Generation complete!'
        previewEl.textContent = data.output
        renderEl.srcdoc = data.output
        loadCredits()
      }catch(err){
        consoleEl.textContent = 'Error: ' + err.message
      }
    })

    // Copy button
    copyBtn.addEventListener('click', ()=>{
      navigator.clipboard.writeText(previewEl.textContent)
        .then(()=>{ consoleEl.textContent='HTML copied to clipboard!'; })
        .catch(()=>{ consoleEl.textContent='Failed to copy.'; })
    })
  </script>
</body>
</html>
